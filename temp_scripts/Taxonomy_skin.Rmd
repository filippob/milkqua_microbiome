---
title: "Taxonomy_Skinswabs"
author: "Chiara Gini"
date: "12/05/2022"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
library("DT")
library("knitr")
library("tidyr")
library("broom")
library("vegan")
library("ggpubr")
library("ggplot2")
library("reshape2")
library("tidyverse")
library("data.table")
library("ggrepel")
library("tibble")
library("dplyr")
```
 
#COMPARISON BETWEEN TREATMENTS

```{r, echo=FALSE}
# basedir="~/Documents/MILKQUA"
# fname = file.path(basedir,"Config/manifest_skinswab.csv")
# metadata <- fread(fname)
# names(metadata)[1] <- "sample"
# newt = c("T1","T2","T3")
# oldt = unique(metadata$timepoint)
# metadata$timepoint_recoded = newt[match(metadata$timepoint, oldt)]
# metadata <- rename(metadata, timepoint_orig = timepoint, timepoint = timepoint_recoded)

metadata <- fread("/home/oem/Results/SKINSWABS/mapping_milkqua_skinswabs.csv")
names(metadata)[1] <- "sample"
metadata %>%
  group_by(timepoint,treatment) %>%
  dplyr::summarise(N=n())
```

```{r, echo=FALSE}
otu <- fread("/home/oem/Results/SKINSWABS/results/otu_norm_CSS.csv")
otu2 <- otu %>% select(order(colnames(otu)))
# otu2$taxonomy <- paste(otu2$Kingdom,",",otu2$Phylum,",",otu2$Class,",",otu2$Order,",", otu2$Family,",",otu2$Genus,",",otu2$Species)
otu2$Phylum <- paste(otu2$Kingdom, otu2$Phylum, sep = ";")
otu2$Class <- paste(otu2$Phylum, otu2$Class, sep = ";")
otu2$Order <- paste(otu2$Class, otu2$Order, sep = ";")
otu2$Family <- paste(otu2$Order, otu2$Family, sep = ";")
otu2$Genus <- paste(otu2$Genus, otu2$Species, sep = " ")
otu2$Genus <- paste(otu2$Family, otu2$Genus, sep = ";")
#otu2$Species <- paste(otu2$Genus, otu2$Species, sep = ";")
otu2$tax_id <- NULL
```

###Taxa setup

```{r taxa setup, echo =FALSE}
otu2_tax =select(otu2, -1:-6, -54)
otu2_tax <- otu2_tax/colSums(otu2_tax)

##Phyla
otu2_phylum <- cbind(otu2_tax, otu2$Phylum)
colnames(otu2_phylum)[48]<- "phyla"
otu2_phylum <- otu2_phylum %>% group_by(phyla) %>% summarise_all(funs(sum))
otu2_phylum <- as.data.frame(t(otu2_phylum))
colnames(otu2_phylum) <- otu2_phylum[1,]
otu2_phylum <- otu2_phylum[-c(1),]
#otu2_phylum <- cbind(otu2_phylum, treatment=metadata$treatment, timepoint=metadata$timepoint, sample=metadata$sample)

## Classes
otu2_Class <- cbind(otu2_tax, otu2$Class)
colnames(otu2_Class)[48]<- "phyla"
otu2_Class <- otu2_Class %>% group_by(phyla) %>% summarise_all(funs(sum))
otu2_Class <- as.data.frame(t(otu2_Class))
colnames(otu2_Class) <- otu2_Class[1,]
otu2_Class <- otu2_Class[-c(1),]
#otu2_Class <- cbind(otu2_Class, treatment=metadata$treatment, timepoint=metadata$timepoint, sample=metadata$sample)

## Families
otu2_Order <- cbind(otu2_tax, otu2$Order)
colnames(otu2_Order)[48]<- "phyla"
otu2_Order <- otu2_Order %>% group_by(phyla) %>% summarise_all(funs(sum))
otu2_Order <- as.data.frame(t(otu2_Order))
colnames(otu2_Order) <- otu2_Order[1,]
otu2_Order <- otu2_Order[-c(1),]
#otu2_Order <- cbind(otu2_Order, treatment=metadata$treatment, timepoint=metadata$timepoint, sample=metadata$sample)

## Families
otu2_Family <- cbind(otu2_tax, otu2$Family)
colnames(otu2_Family)[48]<- "phyla"
otu2_Family <- otu2_Family %>% group_by(phyla) %>% summarise_all(funs(sum))
otu2_Family <- as.data.frame(t(otu2_Family))
colnames(otu2_Family) <- otu2_Family[1,]
otu2_Family <- otu2_Family[-c(1),]
#otu2_Family <- cbind(otu2_Family, treatment=metadata$treatment, timepoint=metadata$timepoint, sample=metadata$sample)

## Genera
otu2_genus <- cbind(otu2_tax, otu2$Genus)
colnames(otu2_genus)[48]<- "phyla"
otu2_genus <- otu2_genus %>% group_by(phyla) %>% summarise_all(funs(sum))
otu2_genus <- as.data.frame(t(otu2_genus))
colnames(otu2_genus) <- otu2_genus[1,]
otu2_genus <- otu2_genus[-c(1),]
#otu2_genus <- cbind(otu2_genus, treatment=metadata$treatment, timepoint=metadata$timepoint, sample=metadata$sample)

# ##Species
# otu2_Species <- cbind(otu2_tax, otu2$Species)
# colnames(otu2_Species)[48]<- "phyla"
# otu2_Species <- otu2_Species %>% group_by(phyla) %>% summarise_all(funs(sum))
# otu2_Species <- as.data.frame(t(otu2_Species))
# colnames(otu2_Species) <- otu2_Species[1,]
# otu2_Species <- otu2_Species[-c(1),]
# #otu2_Species <- cbind(otu2_Species, treatment=metadata$treatment, timepoint=metadata$timepoint, sample=metadata$sample)
```

###Overall Phyla

```{r phyla average abundances, echo=FALSE}
metadata <- metadata[-c(29),]
metadata_cols = names(metadata)[c(1, 12,14)]
otu2_phylum <- cbind(otu2_phylum, treatment=metadata$treatment, `timepoint-symb`=metadata$`timepoint-symb`, sample=metadata$sample)
#ALTERNATIVE
# otu2_phylum$sample = row.names(otu2_phylum) 
# otu2_phylum <- otu2_phylum %>% inner_join(select(metadata, all_of(metadata_cols)), by="sample")


mO <- reshape2::melt(otu2_phylum,id.vars = metadata_cols, value.name = "counts", variable.name = "phylum")
mO <- mO %>%
  arrange(treatment)

ordered_samples <- metadata %>%
  arrange(metadata$treatment) %>%
  dplyr::select(treatment,sample)

mO$sample <- factor(mO$sample, levels = ordered_samples$sample)
mO$counts <- as.numeric(mO$counts)
mO$treatment <- factor(mO$treatment)

D <- mO %>%
  group_by(phylum) %>%
  summarise(N=n(), avg_abund = round(mean(counts),4), std = round(sd(counts),3)) %>%
  filter(avg_abund>0.005) %>%
  arrange(phylum,avg_abund)  %>%
  mutate(taxa = ifelse(relative_cnts > 0.01, taxa, "other"))

phylum <- D %>%
  group_by(phylum) %>%
  summarize("s"=sum(avg_abund)) %>%
  arrange(desc(s)) %>%
  dplyr::select(phylum,s)

D$phylum <- factor(D$phylum, levels = rev(phylum$phylum[order(phylum$s)]))
D <- D %>%
  arrange(phylum)

kable(D)
```

```{r plot overall phyla, echo=FALSE}
Pphyla <- ggplot(D, aes(x=factor(1), y=avg_abund, fill=phylum)) + geom_bar(width=1,stat="identity", position = "fill")
#Pphyla <- Pphyla + facet_grid(`timepoint-symb`~treatment)
Pphyla <- Pphyla + coord_polar(theta='y', start=0) #activate this if you want a piechart
Pphyla <- Pphyla + geom_label_repel(aes(label = paste0(avg_abund*100, "%"), force=10))
Pphyla <- Pphyla + guides(fill = guide_legend(title = "Phyla")) 
my_palette = get_palette(c("green3","yellow","blue","magenta","cyan","yellow","red","purple","brown", "darkorange1","pink1", "darkorchid1", "seagreen2"), length(unique(D$phylum)))
Pphyla <- Pphyla + xlab("relative abundances") + ylab("percentages")
Pphyla <- Pphyla + scale_fill_manual(values = my_palette)
Pphyla <- Pphyla + theme(text = element_text(size=12),
                axis.text.x = element_text(size=8),
               # # # axis.text.y = element_text(size=4),
               # strip.text = element_text(size = 10),
               axis.text.y = element_blank(),
               axis.ticks.y = element_blank(),
               legend.text=element_text(size=8),
               legend.title=element_text(size=8)
)
print(Pphyla)
ggsave(Pphyla, height = 8, width = 5, filename ="~/Results/SKINSWABS/results/taxonomy_overall_phylum_piechart_skinswab_tot.png")

D %>% group_by(phylum) %>% summarise(treatment=n())
D %>% group_by(treatment) %>% summarise(phylum=n())
```

###Phyla

```{r phyla average abundances, echo=FALSE}
metadata <- metadata[-c(29),]
metadata_cols = names(metadata)[c(1, 12,14)]
otu2_phylum <- cbind(otu2_phylum, treatment=metadata$treatment, `timepoint-symb`=metadata$`timepoint-symb`, sample=metadata$sample)
#ALTERNATIVE
# otu2_phylum$sample = row.names(otu2_phylum) 
# otu2_phylum <- otu2_phylum %>% inner_join(select(metadata, all_of(metadata_cols)), by="sample")


mO <- reshape2::melt(otu2_phylum,id.vars = metadata_cols, value.name = "counts", variable.name = "phylum")
mO <- mO %>%
  arrange(treatment)

ordered_samples <- metadata %>%
  arrange(metadata$treatment) %>%
  dplyr::select(treatment,sample)

mO$sample <- factor(mO$sample, levels = ordered_samples$sample)
mO$counts <- as.numeric(mO$counts)
mO$treatment <- factor(mO$treatment)

D <- mO %>%
  group_by(phylum, treatment, `timepoint-symb`) %>%
  summarise(N=n(), avg_abund = round(mean(counts),4), std = round(sd(counts),3)) %>%
  filter(avg_abund>0.005) %>%
  arrange(phylum,avg_abund)

phylum <- D %>%
  group_by(phylum) %>%
  summarize("s"=sum(avg_abund)) %>%
  arrange(desc(s)) %>%
  dplyr::select(phylum,s)

D$phylum <- factor(D$phylum, levels = rev(phylum$phylum[order(phylum$s)]))
D <- D %>%
  arrange(phylum)

kable(D)
```

```{r phyla avg abund tile plot, echo=FALSE}
p <- ggplot(mO, aes(x=phylum,y=as.factor(sample),fill=counts))
p <- p + geom_tile()
p <- p + facet_wrap(treatment~`timepoint-symb`, scales = "free_y")
p <- p + ylab("sample")
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1),axis.text.y = element_text(size=9))
p <- p + scale_fill_gradient2(low="red",high = "blue")
p
#ggsave (p, height = 10, width = 20, filename = "taxonomy_count_skinswabs.png")
```


```{r plot phyla, echo=FALSE}
D$treatment = factor(D$treatment, levels = c("Control", "Treated"), ordered = TRUE)

Pphyla <- ggplot(D, aes(x=factor(1), y=avg_abund, fill=phylum)) + geom_bar(width=1,stat="identity", position = "fill")
#Pphyla <- Pphyla + facet_grid(`timepoint-symb`~treatment)
Pphyla <- Pphyla + coord_polar(theta='y', start=0) #activate this if you want a piechart
Pphyla <- Pphyla + geom_label_repel(aes(label = paste0(avg_abund*100, "%"), force=10))
Pphyla <- Pphyla + guides(fill = guide_legend(title = "Phyla")) 
my_palette = get_palette(c("green3","yellow","blue","magenta","cyan","yellow","red","purple","brown", "darkorange1","pink1", "darkorchid1", "seagreen2"), length(unique(D$phylum)))
Pphyla <- Pphyla + xlab("relative abundances") + ylab("percentages")
Pphyla <- Pphyla + scale_fill_manual(values = my_palette)
Pphyla <- Pphyla + theme(text = element_text(size=12),
                axis.text.x = element_text(size=8),
               # # # axis.text.y = element_text(size=4),
               # strip.text = element_text(size = 10),
               axis.text.y = element_blank(),
               axis.ticks.y = element_blank(),
               legend.text=element_text(size=8),
               legend.title=element_text(size=8)
)
print(Pphyla)
ggsave(Pphyla, height = 8, width = 5, filename ="~/Results/SKINSWABS/results/taxonomy_phylum_boxplot_skinswab_tot.png")

D %>% group_by(phylum) %>% summarise(treatment=n())
D %>% group_by(treatment) %>% summarise(phylum=n())
```

```{r}
fit = aov(avg_abund ~ treatment, data = D) ## linear model value = mu + treatment + e (y = mu + x + e)
TukeyHSD(fit, "treatment", ordered = TRUE)
```

### Genera

```{r, echo=FALSE}
otu2_genus <- cbind(otu2_genus, treatment=metadata$treatment, `timepoint-symb`=metadata$`timepoint-symb`, sample=metadata$sample)

mO <- reshape2::melt(otu2_genus,id.vars = metadata_cols, value.name = "counts", variable.name = "genus")
mO <- mO %>%
  arrange(treatment)

ordered_samples <- metadata %>%
  arrange(metadata$treatment) %>%
  dplyr::select(treatment,sample)

mO$sample <- factor(mO$sample, levels = ordered_samples$sample)
mO$counts <- as.numeric(mO$counts)
mO$treatment <- factor(mO$treatment)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE}
D_genus <- mO %>%
  group_by(genus, treatment, `timepoint-symb`) %>%
  summarise(N=n(), avg_abund = round(mean(counts),4), std = round(sd(counts),3)) %>%
  filter(avg_abund>0.005) %>% #it was 0.005 before
  arrange(genus,avg_abund)

genus <- D_genus %>%
  group_by(genus) %>%
  summarize("s"=sum(avg_abund)) %>%
  arrange(desc(s)) %>%
  dplyr::select(genus,s)

D_genus$genus <- factor(D_genus$genus, levels = rev(genus$genus[order(genus$s)]))
D_genus <- D_genus %>%
  arrange(genus)

kable(D_genus)
```

```{r}
D_genus$treatment = factor(D_genus$treatment, levels = c("Control", "Treated"), ordered = TRUE)
D_genus$genus <- gsub(".*;","", D_genus$genus)

P <- ggplot(D_genus, aes(x=factor(1), y=avg_abund, fill=genus)) + geom_bar(width=1,stat="identity",position = "fill")
P <- P + facet_grid(`timepoint-symb`~treatment)
#P <- P + coord_polar(theta='y', start=0) #activate this if you want a piechart
#P <- P + geom_label_repel(aes(label = paste0(avg_abund*100, "%")),position=position_stack (vjust=0.5), size=5)
P <- P + guides(fill = guide_legend(title = "Genus")) 
my_palette = get_palette(c("green3", "darksalmon", "gold","blue","magenta","cyan","yellow","red","gray","purple","brown","black", "darkorange1","pink1", "darkorchid1", "seagreen2", "blueviolet", "darkseagreen3", "gold4", "gainsboro", "cyan3", "bisque", "black", "antiquewhite3"), length(unique(D_genus$genus)))
P <- P + scale_fill_manual(values = my_palette)
P <- P + xlab("Relative abundances") + ylab("Percentages")
P <- P + theme(text = element_text(size=15),
                 axis.text.x = element_text(size=20),
#                # axis.text.y = element_text(size=4),
                 strip.text = element_text(size = 20),
                 axis.text.y = element_blank(),
                 axis.ticks.y = element_blank(),
                 legend.text=element_text(size=15),
                 legend.title=element_text(size=15))
print(P)
ggsave(P, height = 15, width = 30, filename ="~/Results/SKINSWABS/results/taxonomy_genus_boxplot_skinswab_tot.png")

D_genus %>% group_by(genus) %>% summarise(treatment=n())
D_genus %>% group_by(treatment) %>% summarise(genus=n())
```


```{r}
fit = aov(avg_abund ~ treatment, data = D_genus) ## linear model value = mu + treatment + e (y = mu + x + e)
TukeyHSD(fit, "treatment", ordered = TRUE)
```
###combined plots
``` {r}
# pxc <- ggarrange(Pphyla, P, labels = c("Phyla", "Genera"), nrow = 1, ncol = 2, legend = "right", font.label = list(size=30), hjust = 0,  vjust = 0)
# pxc
#ggsave(pxc, height = 30, width = 20, filename ="taxa_plots_combined.png")
```

###Relative abundances table

```{r relative abundances total table}
otu2_genus = subset(otu2_genus, select = -c(`timepoint-symb`, treatment, sample))
otu2_phylum = subset(otu2_phylum, select = -c(`timepoint-symb`, treatment, sample))

otu2_tot <- cbind(otu2_phylum, otu2_Class, otu2_Order, otu2_Family, otu2_genus) #, otu2_Species
taxa_names <- colnames(otu2_tot)
sample_names <- row.names(otu2_tot)
#otu2_tot <- transpose(otu2_tot)
otu2_tot <- as.data.frame(t(otu2_tot))
colnames(otu2_tot) <- sample_names
taxa_names <- as.data.frame(taxa_names)
otu2_tot$`#otu2 ID` <- cbind(taxa_names$taxa_names)
otu2_tot <- otu2_tot %>% dplyr::select(`#otu2 ID`, everything())

otu2_tot <- gather(otu2_tot, key = "sample", value ="counts", -`#otu2 ID`) %>% spread(key = `#otu2 ID`, value = counts)

otu2_tot$treatment = metadata$treatment[match(otu2_tot$sample,metadata$sample)]
otu2_tot$`timepoint-symb`= metadata$`timepoint-symb`[match(otu2_tot$sample,metadata$sample)]
otu2 <- filter(otu2_tot, sample %in% metadata$sample)

mO <- reshape2::melt(otu2,id.vars = metadata_cols, value.name = "counts", variable.name = "taxa")

mO$level <- sapply(mO$taxa, function(x) length(strsplit(as.character(x),";")[[1]]) ) 

get_taxa <- function(x,n) {
  
  z <- strsplit(x, split = ";")
  res = lapply(z, function(x) x[n])
  return(unlist(res))
}

new_taxa <- c(NULL)
for (i in seq_along(mO$counts)) {
  
  arg1 = as.character(mO$taxa[i])
  arg2 = ifelse(mO$level[i] <= 6, mO$level[i], 6)
  
  rr = get_taxa(arg1,arg2)
  new_taxa <- c(new_taxa,rr)
}

mO$new_taxa <- new_taxa

table(mO$level)
neues <- c("phylum","class","order","family","genus") #,"species"
altes <- seq(2,6) #2,7 if we want to include species
mO$level <- neues[match(mO$level,altes)]

## relative abundances
mO$counts <- as.numeric(mO$counts)

mO <- mO %>%
  group_by(level,sample) %>%
  mutate(tot = sum(counts), rel_abundance = counts/tot)

D <- mO %>%
  group_by(level,new_taxa,treatment,`timepoint-symb`) %>%
  summarise(avg_abund = round(mean(rel_abundance),4), std = round(sd(rel_abundance),3))
```

A table of relative abundances (and standard deviations) per taxa and treatment:

```{r, tab2, echo=FALSE}
D <- na.omit(D)
D <- D %>%
  group_by(new_taxa,`timepoint-symb`,treatment) %>%
  filter(avg_abund > 0.01) %>%
  arrange(level,desc(avg_abund))

kable(D)
```
A table of relative abundances in % (and standard deviations) per taxa 

```{r, echo=FALSE}
D <- na.omit(D)
D <- D %>%
  group_by(level) %>%
  filter(avg_abund > 0.01) %>%
  arrange(level,desc(avg_abund*100))

kable(D)
```


Same results, but in wide-format (treatments on the horizontal axis): relative abundances (no standard deviations):

```{r, echo=FALSE}
D$level  <- factor(D$level,levels = c("phylum","class","order","family","genus")) # ,"species"

D0 <- D %>%
  dplyr::select(-c(std)) %>%
  spread(treatment,avg_abund)

# D0[is.na(D0)] <- ""

bg.picker <- function(z) {
  
  if(is.na(z)) {return(NULL)}
  if(is.numeric(z)) {
    
    if(z > 0.05 & z <= 0.10) {return("pink")}
    if(z > 0.10) {return("yellow")}
  }
}

library("formattable")
formattable(D0, list(
  
  `Treated` = color_tile("white","green"),
  `Control` = color_tile("white","deepskyblue")
  # `3 PR` = color_tile("white","yellow"),
  # `4 PR` = color_tile("white","pink"),
  # `5 PR` = color_tile("white","yellow"),
  # `6 PR` = formatter("span",
  #                 style = x ~ style(
  #                   "border-radius" = "4px",
  #                   "padding-right" = "4px",
  #                   "background-color" = sapply(x, bg.picker))
  #                 )
))

```

**timepoint**

```{r, echo=FALSE}
D$level  <- factor(D$level,levels = c("phylum","class","order","family","genus")) #,"species"

D0 <- D %>%
  select(-c(std)) %>%
  spread(`timepoint-symb`,avg_abund)

# D0[is.na(D0)] <- ""

bg.picker <- function(z) {
  
  if(is.na(z)) {return(NULL)}
  if(is.numeric(z)) {
    
    if(z > 0.05 & z <= 0.10) {return("pink")}
    if(z > 0.10) {return("yellow")}
  }
}

library("formattable")
formattable(D0, list(
  
  `1` = color_tile("white","yellow"),
  `2` = color_tile("white","pink"),
  `3` = color_tile("white","yellow")
  # `5 PR` = color_tile("white","yellow"),
  # `6 PR` = formatter("span",
  #                 style = x ~ style(
  #                   "border-radius" = "4px",
  #                   "padding-right" = "4px",
  #                   "background-color" = sapply(x, bg.picker))
  #                 )
))

```


Finally,a bubble chart to visualize relative abundances per taxa and treatment:

```{r, echo=FALSE, fig.height = 14, fig.width = 10}
taxa <- D %>%
  group_by(level,new_taxa,`timepoint-symb`) %>%
  summarize("s"=sum(avg_abund)) %>%
  arrange(desc(s)) %>% #originally was arrange(desc(level, s)) but stopped working reporting that desc() must be called with exactly one argument
  dplyr::select(level,new_taxa,s)

taxa <- taxa %>%
  group_by(level) %>%
  arrange(level,s)

p <- ggplot(D, aes(x = treatment, y = new_taxa))
p <- p + geom_point(aes(size = avg_abund, colour = treatment), alpha = 0.4)
p <- p + facet_grid(level~`timepoint-symb`, scales = "free", space = "free")
p <- p + scale_color_manual(values = c("green3","gold","blue","magenta","cyan","yellow", "green", "coral",  "#E7B800", "#FC4E07"))
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1))
p <- p + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p <- p + theme(axis.text.x = element_text(size=8))
p <- p + theme_bw()
p <- p + xlab("timepoint-symb`") + ylab("average abundances")
p
ggsave (p, height = 13, width = 8, filename = "~/Results/SKINSWABS/results/taxonomy_bubbleplot_skinswabs.png")
```

### Significance of treatments (+ timepoint-symb)
 
The significance of differences between treatments (Control vs Treated with Essential Oil) was evaluated using a linear model (ANOVA) that included the effect of timepoints:
 
$$
counts_{ikj} = \mu + `timepoint-symb`_k + treatment_j + e_{ikj}
$$
This way, the variability due to region is removed when assessing the effect of treatments.
 
```{r, echo=FALSE}
m1 <- mO %>%
  filter(!is.na(level)) %>%
  arrange(level,treatment)

D <- m1 %>%
  group_by(level, new_taxa) %>%
  do(tidy(anova(lm(counts ~ `timepoint-symb`+treatment, data = .)))) %>%
  filter(term == "treatment")

D$level  <- factor(D$level,levels = c("phylum","class","order","family","genus"))
D <- D %>%
  arrange(level,new_taxa)

datatable(D, options = list(pageLength=100)) %>%
  formatStyle('p.value', backgroundColor = styleInterval(0.05, c('yellow', 'white')))

write.csv(D, "~/Results/SKINSWABS/results/one.csv")
```

### Significance of treatments (per timepoint)

The significance of differences between treatments (Control vs Treated) was evaluated using a linear model (ANOVA) that included the effect of time-points:

$$
counts_{ij} = \mu + treatment_j + e_{ij}
$$

this way, the variability due to region is removed when assessing the effect of treatments.

```{r, echo=FALSE}
m1 <- mO %>%
  arrange(level,treatment)

dd_counts <- mO %>%
  group_by(level, new_taxa,`timepoint-symb`,treatment) %>%
  # summarise(avg = mean(counts)) %>%
  summarise(avg = mean(rel_abundance)) %>%
  spread(key = "treatment", value = "avg")

group_by(dd_counts, level) %>% summarise(tot = sum(Treated))

D <- m1 %>%
  group_by(level, new_taxa, `timepoint-symb`) %>%
  do(tidy(anova(lm(counts ~ treatment, data = .)))) %>%
  filter(term == "treatment")

D$level  <- factor(D$level,levels = c("phylum","class","order","family","genus")) #, "species"
D <- D %>%
  arrange(level,new_taxa)

datatable(D, options = list(pageLength=100)) %>% 
  formatStyle('p.value', backgroundColor = styleInterval(0.05, c('yellow', 'white')))

```

```{r, echo=FALSE}
DX <- D %>%
  filter(`p.value` <= 0.05) %>%
  dplyr::select(c(level,new_taxa, `timepoint-symb`, `p.value`)) %>%
  arrange(level,`p.value`)

D0 <- mO %>%
  dplyr::group_by(level,new_taxa, `timepoint-symb`,treatment) %>%
  dplyr::summarise(avg_counts = mean(counts))

to_save = list(D,DX,D0)
save(to_save, file = "~/Results/SKINSWABS/results/taxonomy_skinswabs_tot.RData")

load("~/Results/SKINSWABS/results/taxonomy_skinswabs_tot.RData")
D <- to_save[[1]]
DX <- to_save[[2]]
D0 <- to_save[[3]]

dd <- spread(D0, key = treatment, value = avg_counts)
temp <- inner_join(DX,dd, by = c("level" = "level", "new_taxa" = "new_taxa", "timepoint-symb"="timepoint-symb"))
fwrite(temp, file = "skinswabs_significant_otu2s.csv", col.names = TRUE, sep = ",")
print (dd)
```

```{r, echo=FALSE, warning=FALSE}
load("~/Results/SKINSWABS/results/taxonomy_skinswabs_tot.RData")
D <- to_save[[1]]
DX <- to_save[[2]]
D0 <- to_save[[3]]

D0 <- mutate(D0, avg_counts = avg_counts+1) %>% spread(key = treatment, value = avg_counts)

D1 <- DX %>%
  inner_join(D0, by = c("level" = "level", "new_taxa" = "new_taxa", "timepoint-symb"="timepoint-symb")) %>%
  mutate(p.value = -log10(p.value)) %>%
  gather(key = "treatment", value = "counts", -c(level,new_taxa,`timepoint-symb`, p.value))

D1$level <- factor(D1$level, levels = c("phylum","class","order","family","genus")) #, "species"

D1 <- D1 %>% group_by(level) %>% mutate(tot = sum(counts), relab = counts/tot)

p <- ggplot(D1, aes(x = treatment, y = new_taxa))
p <- p + geom_tile(aes(fill = relab), colour = "white")
p <- p + theme(legend.position="bottom")
p <- p + facet_grid(level~`timepoint-symb`, scales = "free",  space = "free")
p <- p + xlab("Treatments") + ylab("Taxa")
p <- p + scale_fill_gradient(low = "orange", high = "blue")
p <- p + theme(strip.text.y = element_text(size = 5), 
               strip.text.x = element_text(size = 6),
               # axis.text.y = element_text(size = 4),
               axis.text.x = element_text(size = 6),
               axis.title = element_text(size = 6))
p <- p + guides(fill="none") + theme(axis.title.y = element_blank(),
                                     axis.text.y = element_blank(),
                                     axis.ticks.y = element_blank())
p

dd <- D1 %>% mutate(variable = "p-value")

q <- ggplot(dd, aes(x = factor(1), y = new_taxa, group=level))
q <- q + geom_tile(aes(fill = p.value), colour = "white")
q <- q + theme(legend.position="bottom")
q <- q + facet_grid(level~variable, space="free", scales = "free_y")
q <- q + scale_fill_gradient(low = "orange", high = "blue")
q <- q + xlab("Treatments") + ylab("Taxa")
q <- q + theme(strip.text = element_text(size = 4), 
               strip.text.x = element_text(size = 6),
               axis.text.y = element_text(size = 5),
               axis.title = element_text(size = 6))
q <- q + guides(fill=FALSE) + theme(
  # axis.title.x = element_blank(),
  # axis.text.x=element_blank(),
  # axis.ticks.x=element_blank(),
  strip.text.y = element_blank(),
  # axis.text.x = element_blank()
  axis.text.x = element_text(size = 6)
)
q <- q + xlab("") 
q
#ggsave(filename = "~/Results/SKINSWABS/results/heatmap_pvalue_skinswabs.png", plot = q, device = "png", width = 6, height = 6)

figure_final <- ggarrange(q, p, widths=c(0.1, 0.1), labels=c("A", "B"), legend = "bottom")

print(figure_final)
ggsave(filename = "~/Results/SKINSWABS/results/heatmap_skinswabs.png", plot = figure_final, device = "png", width = 15, height = 12)
```

### Extracting estimated coefficients for "significant" otu2s

```{r}
res = data.frame("level"=NULL, "otu"=NULL, "p_value"=NULL, "Control"=NULL,"Treated"=NULL)

DX1 <- DX[-c(1:53),]
DX1$new_taxa <- paste(DX1$new_taxa, "- T", DX1$`timepoint-symb`)
m1$new_taxa <- paste(m1$new_taxa, "- T", m1$`timepoint-symb`)

for (name in DX1$new_taxa) {
  
  print(paste("analysing otu ", name))
  pval = DX1[DX1$new_taxa==name,"p.value"]
  level = DX1[DX1$new_taxa==name,"level"]
  timepoint = DX1[DX1$new_taxa==name, "timepoint-symb"]
  
  ## estimating coefficients
  temp = filter(m1, new_taxa == name)
  temp$treatment <- factor(temp$treatment, levels = c("Control","Treated"))
  g = lm(counts ~ treatment, data = temp)
  
  ## extracting coefficients
  coefs = g$coefficients
  coefs = coefs[!grepl("(Intercept)", names(coefs))]
  names(coefs) = gsub("treatment","",names(coefs))
  coefs = as.data.frame(t(coefs))
  
  ## adding metadata
  coefs["level"] = level
  coefs["otu"] = name
  coefs["p_value"] = pval
  coefs["timepoint"] = timepoint

  # saving results
  res = rbind.data.frame(res, coefs)
}
write.csv(res, "~/Results/SKINSWABS/results/res.csv")
```

```{r}
p <- ggplot(res, aes(x=otu,y=Treated)) 
p <- p + geom_point(aes(colour=factor(timepoint), shape=factor(timepoint)), size=3)
p <- p + scale_fill_manual(values=c("green3", "orange", "blue"))
p <- p + xlab("Genera with significant variation between treatment and control") + ylab("p-value") + labs(colour="Timepoints", shape="Timepoints")
p <- p + coord_flip() + ylim(-0.0081, 0.00669)
p <- p + geom_hline(yintercept=0, linetype="solid", color = "black", size=0.2)
p = p + theme(strip.text = element_text(size = 4),
              axis.text.x = element_text(angle = 90, size = 4, hjust=0.95,vjust=0.2))
ggsave(filename = "~/Results/SKINSWABS/results/dotplot_skinswabs.png", plot = p, device = "png", width = 10, height = 10)
```