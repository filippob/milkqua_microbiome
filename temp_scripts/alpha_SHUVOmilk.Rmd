---
title: "Alpha_SHUVOmilk"
author: "Chiara Gini"
date: "10/10/2022"
output: html_document
---

```{r setup, include=FALSE}
library("DT")
library("knitr")
library("dplyr")
library("tidyr")
library("broom")
library("vegan")
library("scales")
library("stringr")
library("ggplot2")
#library("ggpubr")
# library("madbito")
library("reshape2")
library("gghighlight")
library("data.table")
library("rmarkdown")
library("ggrepel")
library("tibble")
library("ggplot2")
library("tidyverse")
library("ggpubr")
```

## Alpha diversity of SKINSWABs samples

```{r}
project_folder = "/home/mycelium/Results/SHUVO-MILK/"
analysis_folder = "results/"
fname = file.path(project_folder, "mapping_shuvo_milk.csv")

metadata <- fread(fname)
metadata$sample <- "sample-"
metadata$sample<- paste(metadata$`sample-id`, metadata$SID, sep = "")
metadata = filter(metadata, sample != "sample-46")

fname = file.path(project_folder, analysis_folder, "alpha.csv")
alpha <- fread(fname)
alpha = select(alpha, -c(se.chao1, se.ACE))
alpha$`sample-id` <- gsub("\\.", "-", alpha$`sample-id`)

mAlpha <- reshape2::melt(alpha, id.vars = "sample-id", variable.name = "metric", value.name = "value")
mAlpha$type <- metadata$sample_type[match(mAlpha$`sample-id`,metadata$sample)]
mAlpha$Unit <- metadata$Unit[match(mAlpha$`sample-id`,metadata$sample)]

```

## Effect of treatment within timepoint

(T0 is removed because we are not interested in differences before the application of the treatment)

```{r test_alpha_bl, echo=FALSE}
mAlpha$type = factor(mAlpha$type, levels = c("Healthy quarter", "Subclinical quarter", "Farm bulk milk"))

D <- mAlpha %>%
  group_by(metric) %>%
  do(tidy(lm(value ~ type, data = .))) %>%
  filter(term != "(Intercept)")

datatable(D, options = list(pageLength=100)) %>% 
  formatStyle('p.value', backgroundColor = styleInterval(0.05, c('yellow', 'white')))
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
p <- ggplot(data = D, mapping= aes(x=term, y=p.value))
p <- p + geom_point(aes(color = metric, stroke = 1), position=position_jitter(h=0, w=0.27)) #,shape=metric
p <- p + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
p <- p + geom_hline(yintercept=0.05, linetype="dashed", color = "red", size=0.5)
p <- p + geom_hline(yintercept=0.10, linetype="dashed", color = "darkorange", size=0.5)
p <- p + coord_trans(y="log2")
p <- p + scale_y_continuous(breaks=pretty_breaks(n=20)) 
p <- p + scale_y_continuous(breaks = c(0, 0.05, 0.10, 1)) +  theme(axis.text.x = element_text(angle=90))

p

ggsave(filename = "~/Results/SHUVO-MILK/results/alpha.png", width = 4, height = 4, plot = p, device = "png")
```

